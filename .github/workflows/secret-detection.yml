name: Secret Detection

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'release/**'
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write  # For SARIF upload

jobs:
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scan

      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional: for Gitleaks Pro
        with:
          # Use project configuration
          config-path: .gitleaks.toml

      - name: Upload Gitleaks SARIF report
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: gitleaks

      - name: Generate Gitleaks summary
        if: failure()
        run: |
          echo "## ðŸ” Gitleaks Detected Secrets!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ Gitleaks found potential secrets in the code." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the Security tab for details or check the workflow logs." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Remove the secrets from your code" >> $GITHUB_STEP_SUMMARY
          echo "2. Use environment variables or encrypted secrets instead" >> $GITHUB_STEP_SUMMARY
          echo "3. See SECURITY.md for guidance" >> $GITHUB_STEP_SUMMARY

  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scan

      - name: Run TruffleHog
        id: trufflehog
        uses: trufflesecurity/trufflehog@main
        with:
          # Scan the entire git repository
          path: ./
          # Use main branch as base for PR scans
          base: ${{ github.event.pull_request.base.sha || 'main' }}
          head: ${{ github.sha }}
          # Only report verified secrets to reduce false positives
          # Note: --fail and --no-update are added automatically by the action
          extra_args: --only-verified

      - name: Generate TruffleHog summary
        if: failure()
        run: |
          echo "## ðŸ” TruffleHog Detected Verified Secrets!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ TruffleHog found verified secrets in the code." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "These secrets have been verified with the actual service and are confirmed to be valid!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âš ï¸ CRITICAL: These secrets must be rotated immediately!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Rotate the exposed secrets immediately" >> $GITHUB_STEP_SUMMARY
          echo "2. Remove them from your code" >> $GITHUB_STEP_SUMMARY
          echo "3. Use environment variables or encrypted secrets" >> $GITHUB_STEP_SUMMARY
          echo "4. Review git history and consider using git-filter-repo to remove secrets" >> $GITHUB_STEP_SUMMARY
          echo "5. See SECURITY.md for guidance" >> $GITHUB_STEP_SUMMARY

  post-results:
    name: Post Scan Results
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog]
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Post results as PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const gitleaksResult = '${{ needs.gitleaks.result }}';
            const trufflehogResult = '${{ needs.trufflehog.result }}';

            let emoji = 'âœ…';
            let status = 'Passed';
            let message = 'No secrets detected in your changes.';

            if (gitleaksResult === 'failure' || trufflehogResult === 'failure') {
              emoji = 'âŒ';
              status = 'Failed';
              message = 'Secrets detected in your changes!';
            } else if (gitleaksResult === 'cancelled' || trufflehogResult === 'cancelled') {
              emoji = 'âš ï¸';
              status = 'Cancelled';
              message = 'Secret scanning was cancelled.';
            }

            const reportBody = `## ðŸ”’ Secret Detection Report

            **Status:** ${emoji} ${status}

            ${message}

            ### Scan Results

            | Scanner | Result |
            |---------|--------|
            | Gitleaks | ${gitleaksResult === 'success' ? 'âœ… Passed' : gitleaksResult === 'failure' ? 'âŒ Failed' : 'âš ï¸ ' + gitleaksResult} |
            | TruffleHog | ${trufflehogResult === 'success' ? 'âœ… Passed' : trufflehogResult === 'failure' ? 'âŒ Failed' : 'âš ï¸ ' + trufflehogResult} |

            ${gitleaksResult === 'failure' || trufflehogResult === 'failure' ? `
            ### âš ï¸ Action Required

            Secrets were detected in your code. Please:

            1. **Remove the secrets** from your code
            2. **Replace with environment variables** or use encrypted secrets storage
            3. **Never commit secrets** - use \`.env\` files (kept in \`.gitignore\`)
            4. If secrets were already pushed, **rotate them immediately**
            5. Review the Security tab or workflow logs for details

            See [SECURITY.md](${context.payload.repository.html_url}/blob/${context.payload.pull_request.head.ref}/SECURITY.md) for guidance.

            **To skip locally (emergency only):**
            \`\`\`bash
            LEFTHOOK=0 git commit -m "message"
            \`\`\`

            âš ï¸ **Note:** Even if you skip local hooks, CI will still block merging until secrets are removed.
            ` : `
            ### âœ… All Clear!

            No secrets detected in your changes. Great job maintaining security! ðŸŽ‰
            `}

            ---
            *ðŸ¤– Automated security scan powered by [Gitleaks](https://github.com/gitleaks/gitleaks) and [TruffleHog](https://github.com/trufflesecurity/trufflehog)*
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => {
              const isBot = comment.user.type === 'Bot' || comment.user.login === 'github-actions[bot]';
              const hasSecretDetection = comment.body.includes('ðŸ”’ Secret Detection Report');
              return isBot && hasSecretDetection;
            });

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: reportBody
              });
              console.log(`âœ… Updated existing secret detection comment (ID: ${botComment.id})`);
            } else {
              const { data: newComment } = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: reportBody
              });
              console.log(`âœ… Created new secret detection comment (ID: ${newComment.id})`);
            }

      - name: Fail if secrets detected
        if: needs.gitleaks.result == 'failure' || needs.trufflehog.result == 'failure'
        run: |
          echo "::error::Secrets detected! Please remove them before merging."
          exit 1
