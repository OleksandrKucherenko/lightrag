---
# LightRAG Lightweight Configuration for Development
#
# This ConfigMap configures LightRAG to use built-in lightweight storage
# instead of external databases. Perfect for:
#   - Local development and testing
#   - CI/CD pipelines
#   - Quick demos
#   - Learning and experimentation
#
# Benefits:
#   ✓ No external databases required (Redis, Memgraph, Qdrant)
#   ✓ Lower resource requirements (< 2Gi RAM, 1 CPU)
#   ✓ Faster startup time
#   ✓ Simpler deployment (single pod)
#
# Limitations:
#   ✗ Not suitable for production
#   ✗ No data persistence on pod restart (unless PVC is used)
#   ✗ Limited scalability
#   ✗ Lower performance with large datasets
#
# Usage:
#   1. Replace the default configmap:
#      kubectl delete configmap lightrag-config -n lightrag
#      kubectl apply -f lightweight-configmap.yaml
#
#   2. Deploy only LightRAG (skip databases):
#      kubectl apply -f ../00-namespace.yaml
#      kubectl apply -f lightweight-configmap.yaml
#      kubectl apply -f ../02-secrets.yaml
#      kubectl apply -f ../03-storage.yaml
#      kubectl apply -f ../07-lightrag.yaml
#
#   3. Access via port-forward:
#      kubectl port-forward -n lightrag svc/lightrag 9621:9621
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: lightrag-config
  namespace: lightrag
  labels:
    app.kubernetes.io/component: config
    deployment-mode: lightweight
data:
  # Core Configuration
  PUBLISH_DOMAIN: "dev.localhost"
  COMPOSE_PROJECT_NAME: "lightrag"

  # LightRAG Server Configuration
  HOST: "0.0.0.0"
  PORT: "9621"
  WORKERS: "4"  # Reduced for lightweight mode

  # === LIGHTWEIGHT STORAGE CONFIGURATION ===
  #
  # Using built-in storage backends instead of external databases
  #

  # Key-Value Storage: JsonKVStorage
  # Stores data in JSON files on disk (instead of Redis)
  LIGHTRAG_KV_STORAGE: "JsonKVStorage"

  # Vector Storage: NanoVectorDBStorage
  # Lightweight in-memory vector database (instead of Qdrant)
  LIGHTRAG_VECTOR_STORAGE: "NanoVectorDBStorage"

  # Graph Storage: NetworkXStorage
  # Python NetworkX graph library (instead of Memgraph/Neo4j)
  LIGHTRAG_GRAPH_STORAGE: "NetworkXStorage"

  # Database URLs (not used in lightweight mode, but kept for compatibility)
  REDIS_HOST: "localhost"
  REDIS_PORT: "6379"
  QDRANT_URL: "http://localhost:6333"
  MEMGRAPH_URI: "bolt://localhost:7687"

  # LLM Configuration (still required - connects to external API)
  LLM_BINDING: "openai"
  LLM_MODEL: "gpt-4o-mini"
  EMBEDDING_BINDING: "openai"
  EMBEDDING_MODEL: "text-embedding-3-small"

  # Performance Configuration (reduced for lightweight mode)
  MAX_PARALLEL_INSERT: "2"          # Down from 4
  MAX_ASYNC: "4"                    # Down from 8
  LLM_API_TIMEOUT: "120"
  LLM_API_RETRY_ATTEMPTS: "3"
  LLM_CONNECTION_POOL_SIZE: "10"    # Down from 20
  EMBEDDING_BATCH_SIZE: "50"        # Down from 100

  # Node Options (reduced for lightweight mode)
  NODE_OPTIONS: "--max_old_space_size=1024"

---
# Lightweight Storage PVCs
# Only LightRAG storage needed (no database PVCs)
#
# Note: For true ephemeral testing, you can skip this and modify
# the deployment to use emptyDir volumes instead

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: lightrag-storage
  namespace: lightrag
  labels:
    app.kubernetes.io/name: lightrag
    app.kubernetes.io/component: storage
    deployment-mode: lightweight
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi  # Reduced from 20Gi

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: lightrag-inputs
  namespace: lightrag
  labels:
    app.kubernetes.io/name: lightrag
    app.kubernetes.io/component: storage
    deployment-mode: lightweight
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi  # Reduced from 10Gi

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: lightrag-logs
  namespace: lightrag
  labels:
    app.kubernetes.io/name: lightrag
    app.kubernetes.io/component: storage
    deployment-mode: lightweight
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi  # Reduced from 5Gi
