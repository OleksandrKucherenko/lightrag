[settings]
experimental = true
verbose = false                             # enable if SOPS is failing or you need more debug details
sops.age_key_file = ".secrets/mise-age.txt"
sops.rops = false                           # use original SOPS binary not a rops library
sops.strict = false                         # if age key is not provided do not raise an ERROR

[[env]]
MISE_SOPS_AGE_KEY_FILE = ".secrets/mise-age.txt"
SOPS_AGE_KEY_FILE = "{{env.MISE_SOPS_AGE_KEY_FILE}}"

[[env]]
_.file = [".env.secrets.json", ".env"]

[tasks.setup]
description = "Pre-configure project folders"
run = [
    # security storage folder
    "mkdir -p .secrets",
    # caddy
    "mkdir -p docker/data/caddy",
    "mkdir -p docker/etc/caddy",
    # kv
    "mkdir -p docker/data/redis",
    # graph
    "mkdir -p docker/data/memgraph",
    "mkdir -p docker/logs/memgraph",
    # vectors
    "mkdir -p docker/data/qdrant/storage",
    "mkdir -p docker/data/qdrant/snapshots",
    # rag
    "mkdir -p docker/data/lightrag/storage",
    "mkdir -p docker/data/lightrag/inputs",
    "mkdir -p docker/logs/lightrag",
    # webui
    "mkdir -p docker/data/lobechat",
]

[tasks.hosts-update]
description = "Update /etc/hosts with resolved PUBLISH_DOMAIN using hostctl"
run = '''
export HOST_IP=$(bin/get-host-ip.sh)
export PUBLISH_DOMAIN=${PUBLISH_DOMAIN:-dev.localhost}
TEMP=$(mktemp); envsubst < .etchosts > "$TEMP"
sudo hostctl replace lightrag --from "$TEMP"
'''

[tasks.hosts-show]
description = "Show current hostctl lightrag profile status"
run = "hostctl list lightrag"

[tasks.hosts-remove]
description = "Remove lightrag profile from /etc/hosts"
run = "sudo hostctl remove lightrag"

[tasks.hosts-update-windows]
description = "Update Windows hosts file from WSL2 using PowerShell and hostctl"
run = '''
echo "detecting docker host ip... (it is slow, wait please)"
export TEMP="/mnt/c/tmp/.etchosts.lightrag.windows"
export HOST_IP=$(bin/get-host-ip.sh)
export PUBLISH_DOMAIN=${PUBLISH_DOMAIN:-dev.localhost}
echo "HOST_IP: $HOST_IP" "$PUBLISH_DOMAIN"
envsubst < .etchosts > "$TEMP"
echo "Asking for Admin Permissions..."
export WIN_TMP="C:\\tmp\\.etchosts.lightrag.windows"
powershell.exe -NoProfile -Command "sudo hostctl replace lightrag --from $WIN_TMP"
echo "Updated Windows hosts from: $TEMP (C:\\\\tmp\\.etchosts.lightrag.windows)"
'''

[hooks]
enter = ["mise run setup"]

[tools]
age = "latest"
hostctl = "latest"
mkcert = "latest"
sops = "latest"
